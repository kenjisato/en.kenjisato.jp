---
layout: post
title: Separate logic and presentation in GAS and have a (slightly) betterauto-response
  for Google Form
date: '2012-05-21T20:20:00.000+09:00'
author: Kenji Sato
tags:
- Computer
- Web
modified_time: '2013-01-17T23:18:33.816+09:00'
thumbnail: http://4.bp.blogspot.com/-4dZw0dD5ZOc/UPgHTMFR_SI/AAAAAAAAL-8/jJybs4BahGg/s72-c/form.png
blogger_id: tag:blogger.com,1999:blog-2467955603860141067.post-2063148257603077666
blogger_orig_url: http://en.kenjisato.jp/2012/05/separate-logic-and-presentation-in-gas.html
---

<strong>The goal of this post is to make an easy-to-edit auto-response for google apps web form. </strong> This post is the translation in English of my recent post written in Japanese <a href="http://kenjisato-jp.blogspot.jp/2012/05/google.html">論理と表現を分離して Googleフォームの自動返信を少しだけ使いやすくする</a><br /><h4>Background</h4><a href="http://support.google.com/docs/bin/answer.py?hl=en&amp;answer=87809">Google Docs (or Drive) offers a very handy web form and you can make and share it in seconds</a>. If you are wondering how to make a registration form for your low budget meetings or short-run projects, Google Form would be a perfect choice.<br />However, when used with the default setting, the Google form works not that perfect: You may have wondered how to force it send an auto-response message for the submitter. I suppose this is intentional not to make it a playground for spammers. But don't they allow us to have such a functionality even for temporary websites, or in limited-access areas?<br />The answer is YES. You can make it work with Google Apps Script. See, for example, <a href="https://developers.google.com/apps-script/articles/helpdesk_tutorial#section1">Tutorial: Automating a Help Desk Workflow</a>. The idea is simple: Watch the submission event and let it trigger an email sending script.<br /><h4>Why I didn't fully appreciate it</h4>In the above mentioned tutorial site, you saw a very small piece of script that works perfectly. But I was not content with that solution. In common situations, I suppose, you, programmer, set up a web form and your non-programmer colleague actually uses it.  So, I wondered: <strong>How do they edit the template for the auto-response message? Should you explain that \n means a new line, put a semicolon at the end of the sentence, don't use a quotation mark between quotation marks and stuff like that?</strong> Who becomes happy in such a situation?<br /><h4>What I did</h4>Here I show one way to make the script read a template that is easily editable for non-programmers. What I wanted is something like the relationship between HTML and CSS: <br /><blockquote>CSS is designed primarily to enable the separation of document content (written in HTML or a similar markup language) from document presentation, including elements such as the layout, colors, and fonts. (Quoted from <a href="http://en.wikipedia.org/wiki/Cascading_Style_Sheets">Wikipedia</a>)</blockquote><strong>Separation is always good.</strong> So, let's do it with Google form too. <br /><strong>Step 1.</strong> Create a form. Because this is a demonstration only, I put only two text boxes: Name and E-mail. ...Sorry for the Japanese in the pic :( <br /> <div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-4dZw0dD5ZOc/UPgHTMFR_SI/AAAAAAAAL-8/jJybs4BahGg/s1600/form.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="175" width="320" src="http://4.bp.blogspot.com/-4dZw0dD5ZOc/UPgHTMFR_SI/AAAAAAAAL-8/jJybs4BahGg/s320/form.png" /></a></div>   <strong>Step 2.</strong> Create a document like <a href="https://docs.google.com/document/d/14O7df3d_kNiKB6tDhgzrLz2vhaDKCc4fbiS3O_KmC88/edit">THIS</a> (This doc is publicly visible). Step 2 and 3 are interchangeable. I present this way to specify the requirement of the script. After creating the template, look at the URI and find the document ID (in my case, it's 14O7df3d_kNiKB6tDhgzrLz2vhaDKCc4fbiS3O_KmC88).<br /> <div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-XjS-Ipnz5Lk/UPgHgkbbXdI/AAAAAAAAL_I/4vBt-wyJhKk/s1600/doc.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="261" width="320" src="http://4.bp.blogspot.com/-XjS-Ipnz5Lk/UPgHgkbbXdI/AAAAAAAAL_I/4vBt-wyJhKk/s320/doc.png" /></a></div>    Template is split into three parts by ===’s (more than 3).<br /><ul><li>In the 1st part, the header information is set. You could dynamically change the subject too, but here we just don't do that.</li><li>The body of the message goes in the 2nd part. <strong>When sending the message, the submission contents for Name and E-mail, will replace the doubly-bracketed {{ "{{" }}Name}} and {{ "{{" }}E-mail}}, respectively.</strong> You can also use the default field Timestamp. </li><li>3rd part is ignored.</li></ul><strong>Your non-programmer colleague will be happy with this template? If you think not enough, please make the template neater and the script better.</strong><br /><strong>Step 3.</strong> Here is what I did. (I'm not a pro-programmer, so please teach me if you know a better solution. I really appreciate it.)<br /><h4>Scripting</h4>Let's specify the Doc ID and the name of the column where recipients' email addresses are stored.<br /><code>loadTemplate()</code> function (ll. 42-) reads the template file and returns the header and body while cutting off the 3rd (memo) part. <br />The core is at ll. 22-23. The doubly-bracketed keywords are replaced with the corresponding form entries.<br /><script class="brush: javascript" type="syntaxhighlighter"><![CDATA[  // Doc ID of the template file var id = "koko_ni_id_wo_iretekudasai"; var mailCol = "E-mail";   function onFormSubmit(e){     try {       var ss = SpreadsheetApp.getActiveSpreadsheet();       var r = ss.getLastRow();       var c = ss.getLastColumn();       var rg = ss.getDataRange();               // Processing the body part       var t = loadTemplate(id);       var body = t.body;       var v = {};       for ( var j = 1; j <= c; j++ ){         // Replacing the template keyword into the input value         var cname = rg.getCell(1, j).getValue();         var entry = rg.getCell(r, j).getValue();         v[cname] = entry;                   var re = new RegExp("{{ "{{" }}"+cname+"}}", "g");         body = body.replace(re, entry);       }               // Processing the header part       var mail = v[mailCol];       var subject = t.head.subject;       var opt = { cc: t.head.cc,                    bcc: t.head.bcc,                    replyTo: t.head.replyTo,                    name: t.head.name };               // Sending the message       MailApp.sendEmail( mail, subject, body, opt );     } catch (e) {         // When exception raised          MailApp.sendEmail(Session.getActiveUser().getEmail(), "Error report", e.message);     } }   function loadTemplate(docId){   // Load your template doc file   // docId = Google Docs Document ID    // Find it from doc's URI   var t = DocumentApp.openById(docId).getText();       // Comment out strings after double slashes   t = t.replace(new RegExp("//.*\n", 'g'), "");       // Body part is placed between a pair of lines with more than 3 consecutive ='s    var tsplit = t.split(/===+.*\W+/);       // Retrieving the header part   // that should be placed before the first ===   var head = {};   var lines = tsplit[0].split(/\n+/);   for ( var i in lines ){     var line = lines[i];        if ( null != line.match(/(\w+)\s*=\s*(.+)$/)) {         head[RegExp.$1] = (RegExp.$2).trim();     }   }       // Retrieving the body part   // that should be place between the firs and last ==='s   var body = tsplit[1];       return { head: head, body: body}; } ]]></script>  <br /><h4>Result</h4>The script works like the following pic. So far so good.<br /> <div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-BOfsZzfEgOY/UPgHssamJTI/AAAAAAAAL_U/qU0uXs13ASM/s1600/result.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="125" width="320" src="http://3.bp.blogspot.com/-BOfsZzfEgOY/UPgHssamJTI/AAAAAAAAL_U/qU0uXs13ASM/s320/result.png" /></a></div>   