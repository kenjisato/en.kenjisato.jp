---
layout: post
title: Editing Google form auto-response message with a GUI
date: '2013-03-11T14:47:00.000+09:00'
author: Kenji Sato
tags: 
modified_time: '2013-03-11T15:03:00.912+09:00'
thumbnail: http://4.bp.blogspot.com/-wK_s72Xy910/UT1rhNhaeEI/AAAAAAAANvk/sl5_DfaDq2g/s72-c/1.png
blogger_id: tag:blogger.com,1999:blog-2467955603860141067.post-8911873919381299910
blogger_orig_url: http://en.kenjisato.jp/2013/03/editing-google-form-auto-response.html
---

<p>A typical scenario when using Google's live form might be like: A programmer writes a short script to do some automatic tasks such as auto-response on form submit, a non-programmer colleague tests, and then the programmer will do minor tweaks whenever some change occur. Even when the change is limited in the message body. So, let's make a template and be free from supporting tasks. The GUI for template editing looks like the picture below: </p>  <a href="http://4.bp.blogspot.com/-wK_s72Xy910/UT1rhNhaeEI/AAAAAAAANvk/sl5_DfaDq2g/s1600/1.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-wK_s72Xy910/UT1rhNhaeEI/AAAAAAAANvk/sl5_DfaDq2g/s320/1.png" /></a>  <p>The resulting auto-response message looks like: </p> <a href="http://2.bp.blogspot.com/-gNOqAl1cGJo/UT1sAVBSq5I/AAAAAAAANvs/72DYMoJaTbQ/s1600/2.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-gNOqAl1cGJo/UT1sAVBSq5I/AAAAAAAANvs/72DYMoJaTbQ/s320/2.png" /></a>   <p><strong>Please use the following script on your own responsibility!!</strong></p>   <p>I assume the form has three columns "<b>Timestamp</b>", "<b>Name</b>", and "<b>Email Address</b>." The "<b>Timestamp</b>" column might have a different name if your Google docs's language is not set to English. And please create a sheet named "<b>Configure</b>" with specific entries. See the picture below.</p>  <a href="http://2.bp.blogspot.com/-VeqApHuCWCY/UT1tQvzfhjI/AAAAAAAANv4/KF0Vw5jYpIY/s1600/3.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-VeqApHuCWCY/UT1tQvzfhjI/AAAAAAAANv4/KF0Vw5jYpIY/s320/3.png" /></a>   <p>This second sheet is used to store the template information. I owe this idea to handle global variables to <a href="http://googleappsdeveloper.blogspot.jp/2012/05/insider-tips-for-using-apps-script-and.html">an article in Google Apps Developer Blog</a>. If you wish to share configuration information for multiple forms, you might want to store it to another spreadsheet. You can do it with a minor modification. Let's see the scripts.</p>  <p>Base variables and functions are defined in the following script.</p> <script type='syntaxhighlighter' class='brush: javascript' title='Base'><![CDATA[ // YOU NEED TO SPECIFY THE COLUMN NAME FOR EMAIL ADDRESSES  var ADDRESS_COLUMN = "Email Address";  // ADMINISTRATOR'S ADDRESS  var ADMIN = "kenji@kenjisato.jp";  // HANDLING GLOBAL VARIABLES // http://googleappsdeveloper.blogspot.jp/2012/05/insider-tips-for-using-apps-script-and.html var SHT_CONFIG = 'Configuration'; var globals = new Array();  function LoadGlobals(g) {   gout = (g.length == 0) ? LoadGlobals_(       SpreadsheetApp.getActive(), SHT_CONFIG)       : g;   return gout; }  // Generate gloabal variables to be loaded into globals array function LoadGlobals_(wb, configSheet) {   var configsheet = wb.getSheetByName(configSheet);   var tGlobals = new Array();    // Config data is structured as VARIABLE, ISARRAY, VALUE(S)   // and includes that as the header row   var cfgdata = configsheet.getDataRange().getValues();   for (i = 1; i < cfgdata.length; i++) {     switch (cfgdata[i][1]) {       case 'ARRAY':         // treat as an array - javascript puts a null value in the         // array if you split an empty string...         if (cfgdata[i][2].length == 0) {           tGlobals[cfgdata[i][0]] = new Array();         } else {           tGlobals[cfgdata[i][0]] = cfgdata[i][2].split(',');         }         break;       // Define your own YOURDATATYPE using your customTreatment function (or       // just perform the treatment here)       case 'YOURDATATYPE':         tGlobals[cfgdata[i][0]] = customTreatment(cfgdata[i][2]);         break;       default: // treat as generic data (string)         tGlobals[cfgdata[i][0]] = cfgdata[i][2];     }   }   return tGlobals }  // Update global variables function UpdateGlobals() {   var configsheet = SpreadsheetApp.getActive().getSheetByName(SHT_CONFIG);   var range = configsheet.getDataRange();   var cfgdata = range.getValues();   for (i = 1; i < cfgdata.length; i++) {     var tmp = (typeof globals[cfgdata[i][0]] === "undefined") ? "" : globals[cfgdata[i][0]];     switch (cfgdata[i][1]) {       case 'ARRAY':         range.getCell(i+1, 3).setValue(tmp.join(","));         break;       // Define your own YOURDATATYPE using your customTreatment function (or       // just perform the treatment here)       case 'YOURDATATYPE':         // Do something you want it to be done         break;       default: // treat as generic data (string)         range.getCell(i+1, 3).setValue(tmp);     }   }   globals = [];   globals = LoadGlobals(globals); }  // GETTING CLUMN NAMES function getColNames(sheet) {   var c = sheet.getLastColumn();   return sheet.getRange(1, 1, 1, c).getValues()[0];   }  // ADDING MENUS function onOpen(){   var arrAutoReply = [     {name: "Template", functionName: "templateUi"}   ];      var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();   spreadsheet.addMenu("AUTOREPLY", arrAutoReply); }  ]]></script> <p>Making GUI with the following script. </p><script type='syntaxhighlighter' class='brush: javascript' title='GUI'><![CDATA[ function templateUi() {   globals = LoadGlobals(globals);        // GUI Initialization   var ss = SpreadsheetApp.getActiveSpreadsheet();   var myapp = UiApp.createApplication().setTitle( "Auto Reply Message" ).setHeight(550).setWidth(600);      // Headers   var headGrid = myapp.createGrid(6, 2);   var nameBox = myapp.createTextBox().setName('nameBox').setId('nameBox').setWidth('500px');   var toBox = myapp.createTextBox().setName('toBox').setId('toBox').setWidth('500px').setEnabled(false);   var ccBox = myapp.createTextBox().setName('ccBox').setId('ccBox').setWidth('500px');   var bccBox = myapp.createTextBox().setName('bccBox').setId('bccBox').setWidth('500px');   var repBox = myapp.createTextBox().setName('repBox').setId('repBox').setWidth('500px');   var titleBox = myapp.createTextBox().setName('titleBox').setId('titleBox').setWidth('500px');   headGrid.setCellSpacing(2);   headGrid.setWidget(0, 0, myapp.createLabel( "Sender" ).setWidth('50px'));   headGrid.setWidget(0, 1, nameBox);   headGrid.setWidget(1, 0, myapp.createLabel( "To" ).setWidth('50px'));   headGrid.setWidget(1, 1, toBox);   headGrid.setWidget(2, 0, myapp.createLabel( "CC" ).setWidth('50px'));   headGrid.setWidget(2, 1, ccBox);   headGrid.setWidget(3, 0, myapp.createLabel( "BCC" ).setWidth('50px'));   headGrid.setWidget(3, 1, bccBox);   headGrid.setWidget(4, 0, myapp.createLabel( "ReplyTo" ).setWidth('50px'));   headGrid.setWidget(4, 1, repBox);   headGrid.setWidget(5, 0, myapp.createLabel( "Subject" ).setWidth('50px'));   headGrid.setWidget(5, 1, titleBox);      // Body   var bodyGrid = myapp.createGrid(1,1);   var bodyBox = myapp.createTextArea().setName('bodyBox').setId('bodyBox').setWidth('555px').setHeight('250px');   bodyGrid.setWidget(0, 0, bodyBox);      // Keys   var keyGrid = myapp.createGrid(1, 2);   var keyBox = myapp.createTextBox().setName('keyBox').setId('keyBox').setWidth('500px').setEnabled(false);   keyGrid.setCellSpacing(2);   keyGrid.setWidget(0, 0, myapp.createLabel( "Keys" ).setWidth('50px'));   keyGrid.setWidget(0, 1, keyBox);      var h = getColNames(ss.getSheets()[0]);   var keys = "";   for (var i in h) {     keys = keys + "{{ "{{" }}" + h[i] + "}}  ";    }   keyBox.setValue(keys);      // Save Button   var saveButton = myapp.createButton( "SAVE" ).setId("saveButton").setWidth('270px');   var clickhandler = myapp.createServerClickHandler("onClickSaveButton");   clickhandler.addCallbackElement(nameBox);   clickhandler.addCallbackElement(ccBox);   clickhandler.addCallbackElement(bccBox);   clickhandler.addCallbackElement(repBox);   clickhandler.addCallbackElement(titleBox);   clickhandler.addCallbackElement(bodyBox);   saveButton.addClickHandler(clickhandler);      // Cancel Button   var cancelButton = myapp.createButton( "CANCEL" ).setWidth('270px');   var clickhandler = myapp.createServerClickHandler("onClickCancelButton");   cancelButton.addClickHandler(clickhandler)      // Arrange Buttons   var buttonPanel = myapp.createHorizontalPanel();   buttonPanel.add(saveButton);   buttonPanel.add(cancelButton);      // Arrange Panels   var mainPanel = myapp.createVerticalPanel();   mainPanel.add(headGrid);    mainPanel.add(bodyGrid);   mainPanel.add(keyGrid);   mainPanel.add(buttonPanel);      // Fill in the boxes   toBox.setValue("(Submitted value)");   var name = (typeof globals.name === "undefined") ? "" : globals.name; nameBox.setValue(name);   var cc = (typeof globals.cc === "undefined") ? "" : globals.cc; ccBox.setValue(cc);   var bcc = (typeof globals.bcc === "undefined") ? "" : globals.bcc; bccBox.setValue(bcc);   var rep = (typeof globals.replyTo === "undefined") ? "" : globals.replyTo; repBox.setValue(rep);   var subject = (typeof globals.subject === "undefined") ? "" : globals.subject; titleBox.setValue(subject);   var body = (typeof globals.body === "undefined") ? "" : globals.body; bodyBox.setValue(body);      myapp.add(mainPanel);   ss.show(myapp); }  function onClickSaveButton(e){   var app = UiApp.getActiveApplication();      globals["name"] = e.parameter.nameBox;   globals["cc"] = e.parameter.ccBox;   globals["bcc"] = e.parameter.bccBox;   globals["replyTo"] = e.parameter.repBox;   globals["subject"] = e.parameter.titleBox;   globals["body"] = e.parameter.bodyBox;      UpdateGlobals();      app.close();   return app; }  function onClickCancelButton(e){   var app = UiApp.getActiveApplication();   app.close();   return app; } ]]></script> <p>Lastly, setup the script for auto-response function. </p> <script type='syntaxhighlighter' class='brush: javascript' title='Reply'><![CDATA[ // Auto Reply function onFormSubmit(e) {   globals = LoadGlobals(globals);      try {       var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();             var h = getColNames(sheet);       var toAddr = e.namedValues[ADDRESS_COLUMN].toString();              if ( typeof globals.subject === "undefined" ) {         var subject = "no title";         } else {         var subject = globals.subject;       }       var msg = globals.body;              // Processing the template       for(var i in h){         if ( typeof e.namedValues[h[i]] === "undefined" ) { continue; }         subject = subject.replace(new RegExp("{{ "{{" }}" + h[i] + "}}", "g"), e.namedValues[h[i]].toString());         msg = msg.replace(new RegExp("{{ "{{" }}" + h[i] + "}}", "g"), e.namedValues[h[i]].toString());       }            var cc = (typeof globals.cc === "undefined") ? "" : globals.cc;       var replyTo = (typeof globals.replyTo === "undefined") ? "" : globals.replyTo;       var name = (typeof globals.name === "undefined") ? "" : globals.name;            // Plaintext Message       // MailApp.sendEmail(toAddr, subject, msg, {cc: cc, replyTo : replyTo, name: name });            // HTML Message       MailApp.sendEmail(toAddr, subject, "", {htmlBody: msg, cc: cc, replyTo : replyTo, name: name });        } catch (e) {         // Sending an error message         MailApp.sendEmail(ADMIN, "Error report", e.message);     } }   ]]></script>  <p>Done!</p>